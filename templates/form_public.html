{% extends "base.html" %}
{% block content %}

{% macro render_field(field, prefix, inactive, depth=0) %}
{% set form_name = prefix ~ field.key %}
{% set picker = field_picker(field) %}
{% set index_token = "__INDEX_D" ~ depth ~ "__" %}
{% set depth_mod = depth % 6 %}
{% if depth_mod == 0 %}
  {% set indent_border_color = "border-slate-300" %}
  {% set entry_bg_class = "bg-slate-50/40" %}
{% elif depth_mod == 1 %}
  {% set indent_border_color = "border-sky-300" %}
  {% set entry_bg_class = "bg-sky-50" %}
{% elif depth_mod == 2 %}
  {% set indent_border_color = "border-emerald-300" %}
  {% set entry_bg_class = "bg-emerald-50" %}
{% elif depth_mod == 3 %}
  {% set indent_border_color = "border-amber-300" %}
  {% set entry_bg_class = "bg-amber-50" %}
{% elif depth_mod == 4 %}
  {% set indent_border_color = "border-rose-300" %}
  {% set entry_bg_class = "bg-rose-50" %}
{% else %}
  {% set indent_border_color = "border-violet-300" %}
  {% set entry_bg_class = "bg-violet-50" %}
{% endif %}
{% set nested_indent_class = "border-l-2 " ~ indent_border_color ~ " " ~ entry_bg_class ~ " pl-3 pr-0 pt-2 pb-0" %}
{% set group_container_class = nested_indent_class %}
{% set array_entry_class = "border-l-2 " ~ indent_border_color ~ " " ~ entry_bg_class ~ " pl-3 pr-0 pt-2 pb-0" %}

{% if field.type == "group" %}
  {% if field.is_array %}
  {# 配列グループ #}
  <div class="py-2 lg:py-3">
    <div class="text-sm font-semibold leading-6 text-slate-700">
      {{ field.label or field.key }}
      {% if field.required %}
      <span class="text-rose-500">*</span>
      {% endif %}
    </div>
    {% if field.description %}
    <div class="mt-1 text-xs leading-relaxed text-slate-500">{{ field.description }}</div>
    {% endif %}
    <div class="array-group mt-2" data-prefix="{{ form_name }}" data-index-token="{{ index_token }}">
      <div class="array-group-items"></div>
      <div class="mt-2 flex flex-wrap items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <button type="button" class="group-prev rounded border border-slate-300 px-2 py-1 text-xs" {% if inactive %}disabled{% endif %}>前へ</button>
          <span data-role="group-pagination" class="min-w-[3.5rem] text-center text-xs text-slate-500">0/0</span>
          <button type="button" class="group-next rounded border border-slate-300 px-2 py-1 text-xs" {% if inactive %}disabled{% endif %}>次へ</button>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" class="add-group-item rounded border border-slate-300 px-3 py-1 text-xs" {% if inactive %}disabled{% endif %}>追加</button>
          <button type="button" class="remove-group-item-current whitespace-nowrap rounded border border-rose-300 px-2 py-1 text-xs text-rose-600" {% if inactive %}disabled{% endif %}>削除</button>
        </div>
      </div>
      <template>
        <div class="array-group-entry {{ array_entry_class }}">
          <div class="space-y-2">
            {% for child in field.children %}
            {{ render_field(child, form_name ~ "." ~ index_token ~ ".", inactive, depth + 1) }}
            {% endfor %}
          </div>
        </div>
      </template>
    </div>
  </div>
  {% else %}
  {# 通常グループ #}
  <div class="py-2 lg:py-3">
    <div class="text-sm font-semibold leading-6 text-slate-700">
      {{ field.label or field.key }}
      {% if field.required %}
      <span class="text-rose-500">*</span>
      {% endif %}
    </div>
    {% if field.description %}
    <div class="mt-1 text-xs leading-relaxed text-slate-500">{{ field.description }}</div>
    {% endif %}
    <div class="mt-2 {{ group_container_class }}">
      <div class="space-y-3">
        {% for child in field.children %}
        {{ render_field(child, form_name ~ ".", inactive, depth + 1) }}
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

{% else %}
  {# 通常フィールド（非グループ） #}
  {% set ns = namespace(fw="max-w-md") %}
  {% set depth_offset_px = depth * 12 %}
  {% if field.type in ["number", "integer"] %}
    {% set ns.fw = "max-w-[10rem]" %}
  {% elif picker in ["date", "time"] %}
    {% set ns.fw = "max-w-[11rem]" %}
  {% elif picker %}
    {% set ns.fw = "max-w-xs" %}
  {% elif field.type == "enum" or field_input_type(field) in ["email", "url"] %}
    {% set ns.fw = "max-w-sm" %}
  {% endif %}
  <div class="py-2 lg:py-3">
    <div class="sf-field-row lg:grid lg:grid-cols-12 lg:items-start lg:gap-4" style="--sf-depth-offset: {{ depth_offset_px }}px;">
      <div class="lg:col-span-3">
        <label class="block text-sm font-semibold leading-6">
          {{ field.label or field.key }}
          {% if field.required %}
          <span class="text-rose-500">*</span>
          {% endif %}
        </label>
        {% if field.description %}
        <div class="mt-0.5 text-xs leading-relaxed text-slate-500">{{ field.description }}</div>
        {% endif %}
      </div>

      <div class="sf-field-input-col lg:col-span-9">
        {% if field.is_array %}
          {% if field.type == "file" %}
            <input type="file" name="{{ form_name }}" multiple class="mt-1 w-full {{ ns.fw }} rounded border border-slate-300 px-2 py-2 lg:mt-0" {% if inactive %}disabled{% endif %} />
          {% else %}
            <div class="array-field mt-1 w-full {{ ns.fw }} lg:mt-0" data-key="{{ form_name }}" data-type="{{ field.type }}" data-picker="{{ picker }}">
              <div class="space-y-2 array-items"></div>
              <button type="button" class="add-item mt-1 rounded border border-slate-300 px-3 py-1 text-xs" {% if inactive %}disabled{% endif %}>追加</button>
              <template>
                <div class="flex items-center gap-2 array-item">
                  {% if field.type == "enum" %}
                  <select name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                    {% for option in field.enum %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                  </select>
                  {% elif field.type == "boolean" %}
                  <select name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                    <option value="true">true</option>
                    <option value="false">false</option>
                  </select>
                  {% elif field.type in ["number", "integer"] %}
                  <input type="number" name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.type == "number" %}step="any"{% else %}step="1"{% endif %} {% if inactive %}disabled{% endif %} />
                  {% elif field.multiline %}
                  <textarea name="{{ form_name }}" placeholder="{{ field.placeholder }}" rows="3" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}></textarea>
                  {% else %}
                  <input type="text" name="{{ form_name }}" placeholder="{{ field.placeholder }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if inactive %}disabled{% endif %} />
                  {% endif %}
                  <button type="button" class="remove-item shrink-0 whitespace-nowrap rounded border border-rose-300 px-2 py-1 text-xs text-rose-600" {% if inactive %}disabled{% endif %}>削除</button>
                </div>
              </template>
            </div>
          {% endif %}
        {% else %}
          {% if field.type == "enum" %}
          <select name="{{ form_name }}" class="mt-1 w-full {{ ns.fw }} rounded border border-slate-300 px-2 py-2 text-sm lg:mt-0" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}>
            <option value="">選択してください</option>
            {% for option in field.enum %}
            <option value="{{ option }}">{{ option }}</option>
            {% endfor %}
          </select>
          {% elif field.type == "boolean" %}
          <div class="mt-1 flex items-center gap-2">
            <input type="checkbox" name="{{ form_name }}" value="true" class="h-4 w-4" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
            <span class="text-sm text-slate-700">はい</span>
          </div>
          {% elif field.type == "file" %}
          <input type="file" name="{{ form_name }}" class="mt-1 w-full rounded border border-slate-300 px-2 py-2 lg:mt-0" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
          {% elif field.type in ["number", "integer"] %}
          <input type="number" name="{{ form_name }}" class="mt-1 w-full {{ ns.fw }} rounded border border-slate-300 px-2 py-2 text-sm lg:mt-0" {% if field.type == "number" %}step="any"{% else %}step="1"{% endif %} {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
          {% elif field.multiline %}
          <textarea name="{{ form_name }}" placeholder="{{ field.placeholder }}" rows="4" class="mt-1 w-full rounded border border-slate-300 px-2 py-2 text-sm lg:mt-0" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}></textarea>
          {% else %}
          <input type="{{ field_input_type(field) }}" name="{{ form_name }}" placeholder="{{ field.placeholder }}" class="mt-1 w-full {{ ns.fw }} rounded border border-slate-300 px-2 py-2 text-sm lg:mt-0" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}
{% endmacro %}

<div class="max-w-5xl">
  <h1 class="text-2xl font-semibold">{{ form.name }}</h1>
  {% if form.description %}
  <p class="mt-2 text-sm text-slate-600">{{ form.description }}</p>
  {% endif %}

  {% if errors %}
  <div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
    <ul class="list-disc pl-5">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="post" class="mt-5 space-y-3" enctype="multipart/form-data">
    {% for field in fields %}
    {{ render_field(field, "", inactive, 0) }}
    {% endfor %}

    <button type="submit" class="rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white" {% if inactive %}disabled{% endif %}>送信する</button>
  </form>
</div>

<style>
  .array-group-entry .sf-field-input-col {
    padding-right: 0.5rem;
  }

  @media (min-width: 1024px) {
    .sf-field-input-col {
      margin-left: calc(var(--sf-depth-offset, 0px) * -1);
      width: calc(100% + var(--sf-depth-offset, 0px));
    }
  }
</style>

<script>
  function initPicker(input) {
    if (!input) return;
    if (typeof flatpickr === "undefined") return;
    const kind = input.dataset.picker;
    if (!kind || input._flatpickr) return;
    const options = { locale: "ja" };
    if (kind === "datetime-local") {
      options.enableTime = true;
      options.dateFormat = "Y-m-d\\TH:i";
      options.altInput = true;
      options.altFormat = "Y/m/d H:i";
      options.time_24hr = true;
    } else if (kind === "date") {
      options.dateFormat = "Y-m-d";
      options.altInput = true;
      options.altFormat = "Y/m/d";
    } else if (kind === "time") {
      options.enableTime = true;
      options.noCalendar = true;
      options.dateFormat = "H:i";
      options.time_24hr = true;
      options.altInput = true;
      options.altFormat = "H:i";
    }
    flatpickr(input, options);
  }

  function initArrayFieldBlock(block) {
    if (!block || block.dataset.sfArrayInit === "1") return;
    block.dataset.sfArrayInit = "1";
    const template = block.querySelector("template");
    const list = block.querySelector(".array-items");
    const addButton = block.querySelector(".add-item");
    const picker = block.dataset.picker;
    if (!template || !list || !addButton) return;

    function addItem() {
      const node = template.content.firstElementChild.cloneNode(true);
      const removeButton = node.querySelector(".remove-item");
      if (removeButton) {
        removeButton.addEventListener("click", () => node.remove());
      }
      if (picker) {
        const input = node.querySelector("input[data-picker]");
        initPicker(input);
      }
      list.appendChild(node);
    }

    addButton.addEventListener("click", addItem);
    addItem();
  }

  function initArrayGroupBlock(block) {
    if (!block || block.dataset.sfArrayInit === "1") return;
    block.dataset.sfArrayInit = "1";
    const template = block.querySelector("template");
    const list = block.querySelector(".array-group-items");
    const addButton = block.querySelector(".add-group-item");
    const removeCurrentButton = block.querySelector(".remove-group-item-current");
    const prevButton = block.querySelector(".group-prev");
    const nextButton = block.querySelector(".group-next");
    const paginationLabel = block.querySelector("[data-role='group-pagination']");
    const indexToken = block.dataset.indexToken || "__INDEX__";
    let counter = 0;
    let currentIndex = 0;
    if (!template || !list || !addButton) return;

    function getEntries() {
      return Array.from(list.children).filter((el) => el.classList.contains("array-group-entry"));
    }

    function refreshGroupState() {
      const entries = getEntries();
      const total = entries.length;
      if (total === 0) {
        currentIndex = 0;
      } else if (currentIndex >= total) {
        currentIndex = total - 1;
      } else if (currentIndex < 0) {
        currentIndex = 0;
      }

      entries.forEach((entry, index) => {
        entry.classList.toggle("hidden", index !== currentIndex);
      });

      if (paginationLabel) {
        paginationLabel.textContent = total > 0 ? `${currentIndex + 1}/${total}` : "0/0";
      }
      const controlsLocked = addButton.disabled;
      if (prevButton) {
        prevButton.disabled = controlsLocked || total <= 1 || currentIndex <= 0;
      }
      if (nextButton) {
        nextButton.disabled = controlsLocked || total <= 1 || currentIndex >= total - 1;
      }
      if (removeCurrentButton) {
        removeCurrentButton.disabled = controlsLocked || total <= 0;
      }
    }

    function bootstrapNode(node) {
      node.querySelectorAll("input[data-picker]").forEach(initPicker);
      node.querySelectorAll(".array-field").forEach(initArrayFieldBlock);
      node.querySelectorAll(".array-group").forEach(initArrayGroupBlock);
    }

    function addGroupItem() {
      const node = template.content.firstElementChild.cloneNode(true);
      const idx = counter++;
      node.innerHTML = node.innerHTML.replaceAll(indexToken, String(idx));
      bootstrapNode(node);
      list.appendChild(node);
      currentIndex = getEntries().length - 1;
      refreshGroupState();
    }

    addButton.addEventListener("click", addGroupItem);
    if (removeCurrentButton) {
      removeCurrentButton.addEventListener("click", () => {
        const entries = getEntries();
        if (entries.length === 0) return;
        const target = entries[currentIndex] || entries[entries.length - 1];
        if (!target) return;
        target.remove();
        refreshGroupState();
      });
    }
    if (prevButton) {
      prevButton.addEventListener("click", () => {
        if (currentIndex <= 0) return;
        currentIndex -= 1;
        refreshGroupState();
      });
    }
    if (nextButton) {
      nextButton.addEventListener("click", () => {
        const total = getEntries().length;
        if (currentIndex >= total - 1) return;
        currentIndex += 1;
        refreshGroupState();
      });
    }
    addGroupItem();
  }

  document.querySelectorAll("input[data-picker]").forEach(initPicker);
  document.querySelectorAll(".array-field").forEach(initArrayFieldBlock);
  document.querySelectorAll(".array-group").forEach(initArrayGroupBlock);
</script>
{% endblock %}
