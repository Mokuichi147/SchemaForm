{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl">
  <h1 class="text-2xl font-semibold">{{ form.name }}</h1>
  {% if form.description %}
  <p class="mt-2 text-sm text-slate-600">{{ form.description }}</p>
  {% endif %}

  {% if errors %}
  <div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
    <ul class="list-disc pl-5">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="post" class="mt-6 space-y-5" enctype="multipart/form-data">
    {% for field in fields %}
    {% set picker = field_picker(field) %}
    <div class="rounded border border-slate-200 bg-white p-4">
      <label class="text-sm font-semibold">
        {{ field.label or field.key }}
        {% if field.required %}
        <span class="text-rose-500">*</span>
        {% endif %}
      </label>
      {% if field.description %}
      <div class="text-xs text-slate-500">{{ field.description }}</div>
      {% endif %}

      {% if field.is_array %}
        {% if field.type == "file" %}
          <input type="file" name="{{ field.key }}" multiple class="mt-2 w-full rounded border border-slate-300 px-2 py-2" {% if inactive %}disabled{% endif %} />
        {% else %}
          <div class="array-field mt-2" data-key="{{ field.key }}" data-type="{{ field.type }}" data-picker="{{ picker }}">
            <div class="space-y-2 array-items"></div>
            <button type="button" class="add-item mt-2 rounded border border-slate-300 px-3 py-1 text-xs" {% if inactive %}disabled{% endif %}>追加</button>
            <template>
              <div class="flex items-center gap-2 array-item">
                {% if field.type == "enum" %}
                <select name="{{ field.key }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                  {% for option in field.enum %}
                  <option value="{{ option }}">{{ option }}</option>
                  {% endfor %}
                </select>
                {% elif field.type == "boolean" %}
                <select name="{{ field.key }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
                {% elif field.type in ["number", "integer"] %}
                <input type="number" name="{{ field.key }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %} />
                {% elif field.multiline %}
                <textarea name="{{ field.key }}" placeholder="{{ field.placeholder }}" rows="3" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}></textarea>
                {% else %}
                <input type="text" name="{{ field.key }}" placeholder="{{ field.placeholder }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if inactive %}disabled{% endif %} />
                {% endif %}
                <button type="button" class="remove-item rounded border border-slate-300 px-2 py-1 text-xs" {% if inactive %}disabled{% endif %}>削除</button>
              </div>
            </template>
          </div>
        {% endif %}
      {% else %}
        {% if field.type == "enum" %}
        <select name="{{ field.key }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}>
          <option value="">選択してください</option>
          {% for option in field.enum %}
          <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
        {% elif field.type == "boolean" %}
        <div class="mt-2 flex items-center gap-2">
          <input type="checkbox" name="{{ field.key }}" value="true" class="h-4 w-4" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
          <span class="text-sm text-slate-700">はい</span>
        </div>
        {% elif field.type == "file" %}
        <input type="file" name="{{ field.key }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
        {% elif field.type in ["number", "integer"] %}
        <input type="number" name="{{ field.key }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
        {% elif field.multiline %}
        <textarea name="{{ field.key }}" placeholder="{{ field.placeholder }}" rows="4" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}></textarea>
        {% else %}
        <input type="{{ field_input_type(field) }}" name="{{ field.key }}" placeholder="{{ field.placeholder }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
        {% endif %}
      {% endif %}
    </div>
    {% endfor %}

    <button type="submit" class="rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white" {% if inactive %}disabled{% endif %}>送信する</button>
  </form>
</div>

<script>
  function initPicker(input) {
    if (!input) return;
    if (typeof flatpickr === "undefined") return;
    const kind = input.dataset.picker;
    if (!kind || input._flatpickr) return;
    const options = { locale: "ja" };
    if (kind === "datetime-local") {
      options.enableTime = true;
      options.dateFormat = "Y-m-d\\TH:i";
      options.altInput = true;
      options.altFormat = "Y/m/d H:i";
      options.time_24hr = true;
    } else if (kind === "date") {
      options.dateFormat = "Y-m-d";
      options.altInput = true;
      options.altFormat = "Y/m/d";
    } else if (kind === "time") {
      options.enableTime = true;
      options.noCalendar = true;
      options.dateFormat = "H:i";
      options.time_24hr = true;
      options.altInput = true;
      options.altFormat = "H:i";
    }
    flatpickr(input, options);
  }

  document.querySelectorAll("input[data-picker]").forEach(initPicker);

  document.querySelectorAll(".array-field").forEach((block) => {
    const template = block.querySelector("template");
    const list = block.querySelector(".array-items");
    const addButton = block.querySelector(".add-item");
    const picker = block.dataset.picker;

    function addItem() {
      const node = template.content.firstElementChild.cloneNode(true);
      const removeButton = node.querySelector(".remove-item");
      removeButton.addEventListener("click", () => node.remove());
      if (picker) {
        const input = node.querySelector("input[data-picker]");
        initPicker(input);
      }
      list.appendChild(node);
    }

    addButton.addEventListener("click", addItem);

    addItem();
  });
</script>
{% endblock %}
