{% extends "base.html" %}
{% block content %}

{% macro render_field(field, prefix, inactive) %}
{% set form_name = prefix ~ field.key %}
{% set picker = field_picker(field) %}

{% if field.type == "group" %}
  {% if field.is_array %}
  {# 配列グループ #}
  <div class="rounded border border-slate-200 bg-white p-4">
    <label class="text-sm font-semibold">
      {{ field.label or field.key }}
      {% if field.required %}
      <span class="text-rose-500">*</span>
      {% endif %}
    </label>
    {% if field.description %}
    <div class="text-xs text-slate-500">{{ field.description }}</div>
    {% endif %}
    <div class="array-group mt-2" data-prefix="{{ form_name }}">
      <div class="array-group-items space-y-3"></div>
      <button type="button" class="add-group-item mt-2 rounded border border-slate-300 px-3 py-1 text-xs" {% if inactive %}disabled{% endif %}>追加</button>
      <template>
        <div class="array-group-entry rounded border border-slate-100 bg-slate-50 p-3">
          <div class="flex justify-end">
            <button type="button" class="remove-group-item rounded border border-slate-300 px-2 py-1 text-xs" {% if inactive %}disabled{% endif %}>削除</button>
          </div>
          <div class="space-y-3">
            {% for child in field.children %}
            {{ render_field(child, form_name ~ ".__INDEX__.", inactive) }}
            {% endfor %}
          </div>
        </div>
      </template>
    </div>
  </div>
  {% else %}
  {# 通常グループ #}
  <div class="rounded border-2 border-slate-200 bg-white p-4">
    <div class="text-sm font-semibold text-slate-700">
      {{ field.label or field.key }}
      {% if field.required %}
      <span class="text-rose-500">*</span>
      {% endif %}
    </div>
    {% if field.description %}
    <div class="text-xs text-slate-500">{{ field.description }}</div>
    {% endif %}
    <div class="mt-3 space-y-4">
      {% for child in field.children %}
      {{ render_field(child, form_name ~ ".", inactive) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}

{% else %}
  {# 通常フィールド（非グループ） #}
  <div class="rounded border border-slate-200 bg-white p-4">
    <label class="text-sm font-semibold">
      {{ field.label or field.key }}
      {% if field.required %}
      <span class="text-rose-500">*</span>
      {% endif %}
    </label>
    {% if field.description %}
    <div class="text-xs text-slate-500">{{ field.description }}</div>
    {% endif %}

    {% if field.is_array %}
      {% if field.type == "file" %}
        <input type="file" name="{{ form_name }}" multiple class="mt-2 w-full rounded border border-slate-300 px-2 py-2" {% if inactive %}disabled{% endif %} />
      {% else %}
        <div class="array-field mt-2" data-key="{{ form_name }}" data-type="{{ field.type }}" data-picker="{{ picker }}">
          <div class="space-y-2 array-items"></div>
          <button type="button" class="add-item mt-2 rounded border border-slate-300 px-3 py-1 text-xs" {% if inactive %}disabled{% endif %}>追加</button>
          <template>
            <div class="flex items-center gap-2 array-item">
              {% if field.type == "enum" %}
              <select name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                {% for option in field.enum %}
                <option value="{{ option }}">{{ option }}</option>
                {% endfor %}
              </select>
              {% elif field.type == "boolean" %}
              <select name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}>
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
              {% elif field.type in ["number", "integer"] %}
              <input type="number" name="{{ form_name }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %} />
              {% elif field.multiline %}
              <textarea name="{{ form_name }}" placeholder="{{ field.placeholder }}" rows="3" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if inactive %}disabled{% endif %}></textarea>
              {% else %}
              <input type="text" name="{{ form_name }}" placeholder="{{ field.placeholder }}" class="w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if inactive %}disabled{% endif %} />
              {% endif %}
              <button type="button" class="remove-item rounded border border-slate-300 px-2 py-1 text-xs" {% if inactive %}disabled{% endif %}>削除</button>
            </div>
          </template>
        </div>
      {% endif %}
    {% else %}
      {% if field.type == "enum" %}
      <select name="{{ form_name }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}>
        <option value="">選択してください</option>
        {% for option in field.enum %}
        <option value="{{ option }}">{{ option }}</option>
        {% endfor %}
      </select>
      {% elif field.type == "boolean" %}
      <div class="mt-2 flex items-center gap-2">
        <input type="checkbox" name="{{ form_name }}" value="true" class="h-4 w-4" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
        <span class="text-sm text-slate-700">はい</span>
      </div>
      {% elif field.type == "file" %}
      <input type="file" name="{{ form_name }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
      {% elif field.type in ["number", "integer"] %}
      <input type="number" name="{{ form_name }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
      {% elif field.multiline %}
      <textarea name="{{ form_name }}" placeholder="{{ field.placeholder }}" rows="4" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %}></textarea>
      {% else %}
      <input type="{{ field_input_type(field) }}" name="{{ form_name }}" placeholder="{{ field.placeholder }}" class="mt-2 w-full rounded border border-slate-300 px-2 py-2 text-sm" {% if picker %}data-picker="{{ picker }}"{% endif %} {% if field.required %}required{% endif %} {% if inactive %}disabled{% endif %} />
      {% endif %}
    {% endif %}
  </div>
{% endif %}
{% endmacro %}

<div class="max-w-3xl">
  <h1 class="text-2xl font-semibold">{{ form.name }}</h1>
  {% if form.description %}
  <p class="mt-2 text-sm text-slate-600">{{ form.description }}</p>
  {% endif %}

  {% if errors %}
  <div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
    <ul class="list-disc pl-5">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="post" class="mt-6 space-y-5" enctype="multipart/form-data">
    {% for field in fields %}
    {{ render_field(field, "", inactive) }}
    {% endfor %}

    <button type="submit" class="rounded bg-slate-900 px-4 py-2 text-sm font-semibold text-white" {% if inactive %}disabled{% endif %}>送信する</button>
  </form>
</div>

<script>
  function initPicker(input) {
    if (!input) return;
    if (typeof flatpickr === "undefined") return;
    const kind = input.dataset.picker;
    if (!kind || input._flatpickr) return;
    const options = { locale: "ja" };
    if (kind === "datetime-local") {
      options.enableTime = true;
      options.dateFormat = "Y-m-d\\TH:i";
      options.altInput = true;
      options.altFormat = "Y/m/d H:i";
      options.time_24hr = true;
    } else if (kind === "date") {
      options.dateFormat = "Y-m-d";
      options.altInput = true;
      options.altFormat = "Y/m/d";
    } else if (kind === "time") {
      options.enableTime = true;
      options.noCalendar = true;
      options.dateFormat = "H:i";
      options.time_24hr = true;
      options.altInput = true;
      options.altFormat = "H:i";
    }
    flatpickr(input, options);
  }

  document.querySelectorAll("input[data-picker]").forEach(initPicker);

  document.querySelectorAll(".array-field").forEach((block) => {
    const template = block.querySelector("template");
    const list = block.querySelector(".array-items");
    const addButton = block.querySelector(".add-item");
    const picker = block.dataset.picker;

    function addItem() {
      const node = template.content.firstElementChild.cloneNode(true);
      const removeButton = node.querySelector(".remove-item");
      removeButton.addEventListener("click", () => node.remove());
      if (picker) {
        const input = node.querySelector("input[data-picker]");
        initPicker(input);
      }
      list.appendChild(node);
    }

    addButton.addEventListener("click", addItem);

    addItem();
  });

  document.querySelectorAll(".array-group").forEach((block) => {
    const prefix = block.dataset.prefix;
    const template = block.querySelector("template");
    const list = block.querySelector(".array-group-items");
    const addButton = block.querySelector(".add-group-item");
    let counter = 0;

    function addGroupItem() {
      const node = template.content.firstElementChild.cloneNode(true);
      const idx = counter++;
      node.innerHTML = node.innerHTML.replaceAll("__INDEX__", String(idx));
      const removeButton = node.querySelector(".remove-group-item");
      removeButton.addEventListener("click", () => node.remove());
      node.querySelectorAll("input[data-picker]").forEach(initPicker);
      node.querySelectorAll(".array-field").forEach((af) => {
        const afTemplate = af.querySelector("template");
        const afList = af.querySelector(".array-items");
        const afAdd = af.querySelector(".add-item");
        const afPicker = af.dataset.picker;
        function addArrayItem() {
          const n = afTemplate.content.firstElementChild.cloneNode(true);
          n.querySelector(".remove-item").addEventListener("click", () => n.remove());
          if (afPicker) {
            const inp = n.querySelector("input[data-picker]");
            initPicker(inp);
          }
          afList.appendChild(n);
        }
        afAdd.addEventListener("click", addArrayItem);
        addArrayItem();
      });
      list.appendChild(node);
    }

    addButton.addEventListener("click", addGroupItem);
    addGroupItem();
  });
</script>
{% endblock %}
