{% extends "base.html" %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-3">
  <div>
    <h1 class="text-2xl font-semibold">{% if form %}フォーム編集{% else %}フォーム作成{% endif %}</h1>
    <p class="text-sm text-slate-600">ブロックを追加してフォームを構築します。</p>
  </div>
  {% if form %}
  <div class="flex flex-wrap gap-2 text-sm">
    {% if form.status == "active" %}
    <span class="whitespace-nowrap rounded-full bg-emerald-100 px-3 py-1 text-emerald-800">公開中</span>
    {% else %}
    <span class="whitespace-nowrap rounded-full bg-slate-200 px-3 py-1 text-slate-700">停止中</span>
    {% endif %}
    <a href="/f/{{ form.public_id }}" class="rounded border border-slate-300 px-3 py-1">入力ページ</a>
    <a href="/admin/forms/{{ form.id }}/submissions" class="rounded border border-slate-300 px-3 py-1">送信一覧</a>
  </div>
  {% endif %}
</div>

{% if errors %}
<div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
  <ul class="list-disc pl-5">
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form method="post" action="{% if form %}/admin/forms/{{ form.id }}{% else %}/admin/forms{% endif %}" class="mt-6 space-y-6">
  <div class="rounded-lg border border-slate-200 bg-white p-5">
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="text-sm font-semibold">フォーム名</label>
        <input name="name" value="{{ form.name if form else '' }}" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" required />
      </div>
      <div>
        <label class="text-sm font-semibold">説明</label>
        <input name="description" value="{{ form.description if form else '' }}" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" />
      </div>
    </div>
  </div>

  <div class="rounded-lg border border-slate-200 bg-white p-5">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h2 class="text-lg font-semibold">フィールド</h2>
      <button type="button" id="add-field" class="rounded bg-slate-900 px-3 py-2 text-sm font-semibold text-white">フィールド追加</button>
    </div>
    <p class="mt-2 text-sm text-slate-600">キーは自動生成されます。並び替えはドラッグ操作。</p>

    <div id="field-list" class="mt-4 space-y-3"></div>
  </div>

  <input type="hidden" name="fields_json" id="fields_json" value="" />

  <div class="flex flex-wrap gap-3">
    <button type="submit" class="rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white">保存</button>
    <a href="/admin/forms" class="rounded border border-slate-300 px-4 py-2 text-sm">戻る</a>
    {% if form %}
      {% if form.status == "active" %}
      <button formaction="/admin/forms/{{ form.id }}/stop" formmethod="post" class="rounded border border-slate-300 px-4 py-2 text-sm">停止</button>
      {% else %}
      <button formaction="/admin/forms/{{ form.id }}/publish" formmethod="post" class="rounded border border-slate-300 px-4 py-2 text-sm">公開</button>
      {% endif %}
    {% endif %}
  </div>
</form>

<template id="field-row-template">
  <div class="field-row rounded border border-slate-200 bg-slate-50 p-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2 text-xs font-semibold text-slate-500">
        <span class="drag-handle cursor-move text-sm text-slate-400">↕</span>
        <span data-field-label="type" class="uppercase tracking-wide">-</span>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" data-action="remove" class="rounded border border-slate-300 px-2 py-1 text-xs">削除</button>
      </div>
    </div>
    <input type="hidden" data-field="key" />
    <input type="hidden" data-field="type" />
    <div class="mt-3 grid gap-3 md:grid-cols-2">
      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">ラベル</label>
        <input data-field="label" required class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="表示名" />
      </div>
      <!-- 種類の表示フィールドは削除 -->
      <div class="flex items-center gap-2 pt-5 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="required" />
          必須
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="is_array" />
          配列
        </label>
        <label class="flex items-center gap-2" data-role="multiline">
          <input type="checkbox" data-field="multiline" />
          複数行
        </label>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-3">
      <div data-role="description">
        <label class="text-xs text-slate-500">説明</label>
        <textarea data-field="description" rows="2" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm"></textarea>
      </div>
      <div data-role="placeholder">
        <label class="text-xs text-slate-500">プレースホルダ</label>
        <input data-field="placeholder" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
      </div>
      <div data-role="format">
        <label class="text-xs text-slate-500">フォーマット</label>
        <select data-field="format" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
          <option value="">指定なし</option>
          <option value="email">email</option>
          <option value="date">date</option>
          <option value="url">url</option>
        </select>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-2">
      <div data-role="enum">
        <label class="text-xs text-slate-500">選択肢 (カンマ区切り)</label>
        <input data-field="enum" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="A, B, C" />
      </div>
      <div data-role="minmax" class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-xs text-slate-500">最小値</label>
          <input data-field="min" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="text-xs text-slate-500">最大値</label>
          <input data-field="max" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
      </div>
    </div>
  </div>
</template>

<div id="type-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40">
  <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-lg">
    <div class="text-lg font-semibold">フィールドの種類を選択</div>
    <p class="mt-1 text-sm text-slate-600">追加したい種類を選んでください。</p>
    <div class="mt-4 grid gap-2 sm:grid-cols-2">
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="string">文字列</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="number">数値</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="integer">整数</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="datetime">日時</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="boolean">真偽</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="enum">選択肢</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="file">ファイル</button>
    </div>
    <div class="mt-4 flex justify-end">
      <button type="button" id="close-type-modal" class="rounded border border-slate-300 px-3 py-2 text-sm">キャンセル</button>
    </div>
  </div>
</div>

<script id="fields-data" type="application/json">{{ fields_json | safe }}</script>
<script>
  const fieldList = document.getElementById("field-list");
  const template = document.getElementById("field-row-template");
  const addButton = document.getElementById("add-field");
  const typeModal = document.getElementById("type-modal");
  const closeTypeModal = document.getElementById("close-type-modal");
  const fieldsInput = document.getElementById("fields_json");
  const initialFields = JSON.parse(document.getElementById("fields-data").textContent || "[]");
  const seenKeys = new Set();
  const typeLabels = {
    string: "文字列",
    number: "数値",
    integer: "整数",
    datetime: "日時",
    boolean: "真偽",
    enum: "選択肢",
    file: "ファイル",
  };

  const defaultField = {
    key: "",
    label: "",
    type: "string",
    required: false,
    description: "",
    placeholder: "",
    enum: [],
    min: "",
    max: "",
    format: "",
    is_array: false,
    items_type: "",
    multiline: false,
  };

  function normalizeField(raw) {
    const field = { ...defaultField, ...raw };
    if (!Array.isArray(field.enum)) {
      field.enum = [];
    }
    return field;
  }

  function randomToken() {
    if (window.crypto && crypto.randomUUID) {
      return crypto.randomUUID().replaceAll("-", "");
    }
    return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  }

  function generateKey() {
    return `f_${randomToken()}`;
  }

  function ensureKey(field) {
    if (field.key) {
      seenKeys.add(field.key);
      return field;
    }
    let candidate = generateKey();
    while (seenKeys.has(candidate)) {
      candidate = generateKey();
    }
    field.key = candidate;
    seenKeys.add(candidate);
    return field;
  }

  function setValue(row, name, value) {
    const el = row.querySelector(`[data-field="${name}"]`);
    if (!el) return;
    if (el.type === "checkbox") {
      el.checked = Boolean(value);
    } else if (el.tagName === "TEXTAREA") {
      el.value = value ?? "";
    } else {
      el.value = value ?? "";
    }
    if (name === "type") {
      const labelEl = row.querySelector('[data-field-label="type"]');
      if (labelEl) {
        labelEl.textContent = typeLabels[value] || value || "-";
      }
    }
  }

  function applyMultiline(row) {
    const multiline = row.querySelector('[data-field="multiline"]').checked;
    const container = row.querySelector('[data-role="placeholder"]');
    if (!container) return;
    const current = container.querySelector('[data-field="placeholder"]');
    if (!current) return;
    const wantTag = multiline ? "TEXTAREA" : "INPUT";
    if (current.tagName === wantTag) return;
    const value = current.value;
    let next;
    if (multiline) {
      next = document.createElement("textarea");
      next.rows = 2;
    } else {
      next = document.createElement("input");
      next.type = "text";
    }
    next.dataset.field = "placeholder";
    next.className = current.className;
    next.value = value;
    current.replaceWith(next);
    next.addEventListener("change", () => updateFieldsJson());
    next.addEventListener("input", () => updateFieldsJson());
  }

  function applyVisibility(row) {
    const type = row.querySelector('[data-field="type"]').value;
    const isArray = row.querySelector('[data-field="is_array"]').checked;
    const showEnum = type === "enum";
    const showMinMax = type === "number" || type === "integer";
    const showFormat = type === "string";
    const showMultiline = type === "string";
    row.querySelector('[data-role="enum"]').classList.toggle("hidden", !showEnum);
    row.querySelector('[data-role="minmax"]').classList.toggle("hidden", !showMinMax);
    row.querySelector('[data-role="format"]').classList.toggle("hidden", !showFormat);
    row.querySelector('[data-role="placeholder"]').classList.toggle("hidden", !showFormat);
    row.querySelector('[data-role="multiline"]').classList.toggle("hidden", !showMultiline);

    if (isArray && type === "file") {
      row.querySelector('[data-role="format"]').classList.add("hidden");
      row.querySelector('[data-role="placeholder"]').classList.add("hidden");
    }

    applyMultiline(row);
  }

  function readRow(row) {
    const get = (name) => row.querySelector(`[data-field="${name}"]`);
    const type = get("type").value;
    const isArray = get("is_array").checked;
    const enumRaw = get("enum").value || "";
    const enumValues = enumRaw
      .split(",")
      .map((value) => value.trim())
      .filter((value) => value.length > 0);

    return {
      key: get("key").value.trim(),
      label: get("label").value.trim(),
      type,
      required: get("required").checked,
      description: get("description").value.trim(),
      placeholder: get("placeholder").value.trim(),
      enum: enumValues,
      min: get("min").value.trim(),
      max: get("max").value.trim(),
      format: get("format").value,
      is_array: isArray,
      items_type: isArray ? type : "",
      multiline: get("multiline").checked,
    };
  }

  function updateFieldsJson() {
    const rows = Array.from(fieldList.querySelectorAll(".field-row"));
    const fields = rows.map((row) => readRow(row));
    fieldsInput.value = JSON.stringify(fields);
  }

  function attachRowEvents(row) {
    row.querySelectorAll("input, select, textarea").forEach((input) => {
      input.addEventListener("change", () => {
        applyVisibility(row);
        updateFieldsJson();
      });
      input.addEventListener("input", () => {
        updateFieldsJson();
      });
    });
    row.querySelector('[data-action="remove"]').addEventListener("click", () => {
      row.remove();
      updateFieldsJson();
    });
    applyVisibility(row);
  }

  function addRow(field) {
    const row = template.content.firstElementChild.cloneNode(true);
    const normalized = ensureKey(normalizeField(field));
    setValue(row, "key", normalized.key);
    setValue(row, "label", normalized.label);
    setValue(row, "type", normalized.type);
    setValue(row, "required", normalized.required);
    setValue(row, "description", normalized.description);
    setValue(row, "placeholder", normalized.placeholder);
    setValue(row, "enum", (normalized.enum || []).join(", "));
    setValue(row, "min", normalized.min ?? "");
    setValue(row, "max", normalized.max ?? "");
    setValue(row, "format", normalized.format ?? "");
    setValue(row, "is_array", normalized.is_array);
    setValue(row, "multiline", normalized.multiline);

    attachRowEvents(row);
    fieldList.appendChild(row);
  }

  addButton.addEventListener("click", () => {
    if (typeModal) {
      typeModal.classList.remove("hidden");
      typeModal.classList.add("flex");
    }
  });

  if (closeTypeModal) {
    closeTypeModal.addEventListener("click", () => {
      typeModal.classList.add("hidden");
      typeModal.classList.remove("flex");
    });
  }

  document.querySelectorAll(".type-option").forEach((button) => {
    button.addEventListener("click", () => {
      const selectedType = button.dataset.type || "string";
      addRow({ ...defaultField, type: selectedType });
      updateFieldsJson();
      typeModal.classList.add("hidden");
      typeModal.classList.remove("flex");
    });
  });

  if (initialFields.length > 0) {
    initialFields.forEach((field) => addRow(field));
  }

  updateFieldsJson();

  if (window.Sortable) {
    new Sortable(fieldList, {
      animation: 150,
      handle: ".drag-handle",
      onSort: updateFieldsJson,
    });
  }

  document.querySelector("form").addEventListener("submit", () => {
    updateFieldsJson();
  });
</script>
{% endblock %}
