{% extends "base.html" %}
{% block content %}
<div class="flex flex-wrap items-center justify-between gap-3">
  <div>
    <h1 class="text-2xl font-semibold">{% if form %}フォーム編集{% else %}フォーム作成{% endif %}</h1>
    <p class="text-sm text-slate-600">ブロックを追加してフォームを構築します。</p>
  </div>
  {% if form %}
  <div class="flex flex-wrap gap-2 text-sm">
    {% if form.status == "active" %}
    <form method="post" action="/admin/forms/{{ form.id }}/stop?next=/admin/forms/{{ form.id }}">
      <button type="submit" class="whitespace-nowrap rounded-full bg-emerald-100 px-3 py-1 text-emerald-800 hover:bg-emerald-200">公開中</button>
    </form>
    {% else %}
    <form method="post" action="/admin/forms/{{ form.id }}/publish?next=/admin/forms/{{ form.id }}">
      <button type="submit" class="whitespace-nowrap rounded-full bg-slate-200 px-3 py-1 text-slate-700 hover:bg-slate-300">停止中</button>
    </form>
    {% endif %}
    <a href="/f/{{ form.public_id }}" class="rounded border border-slate-300 px-3 py-1">入力ページ</a>
    <a href="/admin/forms/{{ form.id }}/submissions" class="rounded border border-slate-300 px-3 py-1">送信一覧</a>
  </div>
  {% endif %}
</div>

{% if errors %}
<div class="mt-4 rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
  <ul class="list-disc pl-5">
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form method="post" action="{% if form %}/admin/forms/{{ form.id }}{% else %}/admin/forms{% endif %}" class="mt-6 space-y-6">
  <div>
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="text-sm font-semibold">フォーム名</label>
        <input name="name" value="{{ form.name if form else '' }}" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" required />
      </div>
      <div>
        <label class="text-sm font-semibold">説明</label>
        <textarea name="description" rows="3" class="mt-1 w-full rounded border border-slate-300 px-3 py-2">{{ form.description if form else '' }}</textarea>
      </div>
    </div>
  </div>

  <div>
    <div class="flex flex-wrap items-center gap-3">
      <h2 class="text-lg font-semibold">フィールド</h2>
    </div>
    <p class="mt-2 text-sm text-slate-600">キーは自動生成されます。並び替えはドラッグ操作。</p>

    <div id="field-list" class="mt-4 space-y-3"></div>
    <div class="mt-4 flex justify-start">
      <button type="button" id="add-field" class="rounded bg-slate-900 px-3 py-2 text-sm font-semibold text-white">フィールド追加</button>
    </div>
  </div>

  <details class="mt-6 rounded border border-slate-200">
    <summary class="cursor-pointer px-4 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50">高度な設定</summary>
    <div class="space-y-4 border-t border-slate-200 px-4 py-4">
      <div class="text-sm font-semibold text-slate-600">Webhook設定</div>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="text-sm text-slate-600">Webhook URL</label>
          <input name="webhook_url" value="{{ form.webhook_url if form else '' }}" type="url" placeholder="https://example.com/webhook" class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm" />
          <p class="mt-1 text-xs text-slate-500">送信・削除時に通知を送るURL</p>
        </div>
        <div class="flex items-start gap-6 pt-6">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="webhook_on_submit" {% if form and form.webhook_on_submit %}checked{% endif %} />
            送信時に通知
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="webhook_on_delete" {% if form and form.webhook_on_delete %}checked{% endif %} />
            削除時に通知
          </label>
        </div>
      </div>
    </div>
  </details>

  <input type="hidden" name="fields_json" id="fields_json" value="" />

  <div class="flex flex-wrap gap-3">
    <button type="submit" class="rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white">保存</button>
    <a href="/admin/forms" class="rounded border border-slate-300 px-4 py-2 text-sm">戻る</a>
  </div>
</form>

<template id="field-row-template">
  <div class="field-row rounded border border-slate-200 p-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2 text-xs font-semibold text-slate-500">
        <span class="drag-handle cursor-move text-sm text-slate-400">↕</span>
        <span data-field-label="type" class="uppercase tracking-wide">-</span>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" data-action="remove" class="whitespace-nowrap rounded border border-rose-300 px-2 py-1 text-xs text-rose-600">削除</button>
      </div>
    </div>
    <input type="hidden" data-field="key" />
    <input type="hidden" data-field="type" />
    <div class="mt-3 grid gap-3 md:grid-cols-2">
      <div class="md:col-span-1">
        <label class="text-xs text-slate-500">ラベル</label>
        <input data-field="label" required class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="表示名" />
      </div>
      <!-- 種類の表示フィールドは削除 -->
      <div class="flex items-center gap-2 pt-5 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="required" />
          必須
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" data-field="is_array" />
          配列
        </label>
        <label class="hidden flex items-center gap-2" data-role="expand-rows">
          <input type="checkbox" data-field="expand_rows" />
          送信一覧で展開
        </label>
        <label class="flex items-center gap-2" data-role="multiline">
          <input type="checkbox" data-field="multiline" />
          複数行
        </label>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-3">
      <div data-role="description">
        <label class="text-xs text-slate-500">説明</label>
        <textarea data-field="description" rows="2" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm"></textarea>
      </div>
      <div data-role="placeholder">
        <label class="text-xs text-slate-500">プレースホルダ</label>
        <input data-field="placeholder" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
      </div>
      <div data-role="format">
        <label data-role="format-label" class="text-xs text-slate-500">フォーマット</label>
        <select data-field="format" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
          <option value="">指定なし</option>
        </select>
      </div>
    </div>

    <div class="mt-3 grid gap-3 md:grid-cols-2">
      <div data-role="enum">
        <label class="text-xs text-slate-500">選択肢 (カンマ区切り)</label>
        <input data-field="enum" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder="A, B, C" />
      </div>
      <div data-role="minmax" class="grid grid-cols-2 gap-2">
        <div>
          <label class="text-xs text-slate-500">最小値</label>
          <input data-field="min" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="text-xs text-slate-500">最大値</label>
          <input data-field="max" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" />
        </div>
      </div>
    </div>

    <div data-role="file-extensions" class="mt-3 hidden">
      <label class="text-xs text-slate-500">許可拡張子 (カンマ区切り)</label>
      <input data-field="allowed_extensions_input" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm" placeholder=".pdf, .docx" />
      <p class="mt-1 text-xs text-slate-500">指定した場合はファイル分類よりこちらを優先します。</p>
    </div>

    <div data-role="master-config" class="mt-3 hidden">
      <div class="grid gap-3 md:grid-cols-2">
        <div>
          <label class="text-xs text-slate-500">参照元フォーム</label>
          <select data-field="master_form_id" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
            <option value="">選択してください</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-500">表示名に使うフィールド</label>
          <select data-field="master_label_key" class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-sm">
            <option value="">自動（参照内容から生成）</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <div class="text-xs text-slate-500">子要素として表示するフィールド</div>
        <div data-role="master-display-fields" class="mt-1 grid gap-1.5 rounded border border-slate-200 bg-white px-2 py-2 text-xs text-slate-700"></div>
      </div>
      <p class="mt-1 text-xs text-slate-500">表示は参照元の送信内容から自動生成されます。</p>
    </div>

    <div data-role="group-children" class="mt-3 hidden">
      <div>
        <div class="text-xs font-semibold text-slate-500">子フィールド</div>
        <div class="children-list mt-2 space-y-3"></div>
        <div class="mt-4 flex justify-start">
          <button type="button" data-action="add-child" class="rounded border border-slate-300 px-2 py-1 text-xs">追加</button>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
  .children-list .field-row {
    margin-right: calc(-1rem - 1px);
    padding-right: 1rem;
  }

  .field-row[data-depth-mod="0"] {
    border-color: rgb(203 213 225);
    background-color: rgb(248 250 252 / 0.4);
  }

  .field-row[data-depth-mod="1"] {
    border-color: rgb(125 211 252);
    background-color: rgb(240 249 255);
  }

  .field-row[data-depth-mod="2"] {
    border-color: rgb(110 231 183);
    background-color: rgb(236 253 245);
  }

  .field-row[data-depth-mod="3"] {
    border-color: rgb(252 211 77);
    background-color: rgb(255 251 235);
  }

  .field-row[data-depth-mod="4"] {
    border-color: rgb(253 164 175);
    background-color: rgb(255 241 242);
  }

  .field-row[data-depth-mod="5"] {
    border-color: rgb(196 181 253);
    background-color: rgb(245 243 255);
  }
</style>

<div id="type-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40">
  <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-lg">
    <div class="text-lg font-semibold">フィールドの種類を選択</div>
    <p class="mt-1 text-sm text-slate-600">追加したい種類を選んでください。</p>
    <div class="mt-4 grid gap-2 sm:grid-cols-2">
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="string">文字列</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="number">数値</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="integer">整数</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="datetime">日時</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="date">日付</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="time">時間</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="boolean">真偽</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="enum">選択肢</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="master">フォーム参照</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="file">ファイル</button>
      <button type="button" class="type-option rounded border border-slate-300 px-3 py-2 text-sm" data-type="group">グループ</button>
    </div>
    <div class="mt-4 flex justify-end">
      <button type="button" id="close-type-modal" class="rounded border border-slate-300 px-3 py-2 text-sm">キャンセル</button>
    </div>
  </div>
</div>

<script id="fields-data" type="application/json">{{ fields_json | safe }}</script>
<script id="master-forms-data" type="application/json">{{ master_forms_json | default('[]') | safe }}</script>
<script id="master-fields-data" type="application/json">{{ master_field_catalog_json | default('{}') | safe }}</script>
<script>
  const fieldList = document.getElementById("field-list");
  const template = document.getElementById("field-row-template");
  const addButton = document.getElementById("add-field");
  const typeModal = document.getElementById("type-modal");
  const closeTypeModal = document.getElementById("close-type-modal");
  const fieldsInput = document.getElementById("fields_json");
  const initialFields = JSON.parse(document.getElementById("fields-data").textContent || "[]");
  const masterForms = JSON.parse(document.getElementById("master-forms-data").textContent || "[]");
  const masterFieldCatalog = JSON.parse(document.getElementById("master-fields-data").textContent || "{}");
  const seenKeys = new Set();
  const typeLabels = {
    string: "文字列",
    number: "数値",
    integer: "整数",
    datetime: "日時",
    date: "日付",
    time: "時間",
    boolean: "真偽",
    enum: "選択肢",
    master: "フォーム参照",
    file: "ファイル",
    group: "グループ",
  };
  const stringFormatOptions = [
    { value: "", label: "指定なし" },
    { value: "email", label: "email" },
    { value: "url", label: "url" },
  ];
  const fileFormatOptions = [
    { value: "", label: "指定なし（すべて）" },
    { value: "image", label: "画像" },
    { value: "video", label: "動画" },
    { value: "audio", label: "音声" },
    { value: "document", label: "文書ファイル" },
  ];

  const defaultField = {
    key: "",
    label: "",
    type: "string",
    required: false,
    description: "",
    placeholder: "",
    enum: [],
    min: "",
    max: "",
    format: "",
    allowed_extensions: [],
    is_array: false,
    expand_rows: false,
    items_type: "",
    multiline: false,
    master_form_id: "",
    master_label_key: "",
    master_display_fields: [],
    children: [],
  };

  let pendingAddTarget = null;

  function getRowDepth(row) {
    let depth = 0;
    let current = row.parentElement;
    while (current) {
      if (current.classList && current.classList.contains("children-list")) {
        depth += 1;
      }
      current = current.parentElement;
    }
    return depth;
  }

  function refreshRowDepthStyles() {
    document.querySelectorAll(".field-row").forEach((row) => {
      const depthMod = getRowDepth(row) % 6;
      row.dataset.depthMod = String(depthMod);
    });
  }

  function normalizeField(raw) {
    const field = { ...defaultField, ...raw };
    if (!Array.isArray(field.enum)) {
      field.enum = [];
    }
    if (!Array.isArray(field.children)) {
      field.children = [];
    }
    if (!Array.isArray(field.master_display_fields)) {
      field.master_display_fields = [];
    }
    if (!Array.isArray(field.allowed_extensions)) {
      field.allowed_extensions = [];
    }
    return field;
  }

  function randomToken() {
    if (window.crypto && crypto.randomUUID) {
      return crypto.randomUUID().replaceAll("-", "");
    }
    return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  }

  function generateKey() {
    return `f_${randomToken()}`;
  }

  function ensureKey(field) {
    if (field.key) {
      seenKeys.add(field.key);
      return field;
    }
    let candidate = generateKey();
    while (seenKeys.has(candidate)) {
      candidate = generateKey();
    }
    field.key = candidate;
    seenKeys.add(candidate);
    return field;
  }

  function setValue(row, name, value) {
    const el = row.querySelector(`[data-field="${name}"]`);
    if (!el) return;
    if (el.type === "checkbox") {
      el.checked = Boolean(value);
    } else if (el.tagName === "TEXTAREA") {
      el.value = value ?? "";
    } else {
      el.value = value ?? "";
    }
    if (name === "type") {
      const labelEl = row.querySelector('[data-field-label="type"]');
      if (labelEl) {
        labelEl.textContent = typeLabels[value] || value || "-";
      }
    }
  }

  function applyMultiline(row) {
    const multiline = row.querySelector('[data-field="multiline"]').checked;
    const container = row.querySelector('[data-role="placeholder"]');
    if (!container) return;
    const current = container.querySelector('[data-field="placeholder"]');
    if (!current) return;
    const wantTag = multiline ? "TEXTAREA" : "INPUT";
    if (current.tagName === wantTag) return;
    const value = current.value;
    let next;
    if (multiline) {
      next = document.createElement("textarea");
      next.rows = 2;
    } else {
      next = document.createElement("input");
      next.type = "text";
    }
    next.dataset.field = "placeholder";
    next.className = current.className;
    next.value = value;
    current.replaceWith(next);
    next.addEventListener("change", () => updateFieldsJson());
    next.addEventListener("input", () => updateFieldsJson());
  }

  function refreshFormatOptions(row, preferredValue = null) {
    const typeInput = row.querySelector('[data-field="type"]');
    const formatSelect = row.querySelector('[data-field="format"]');
    const formatLabel = row.querySelector('[data-role="format-label"]');
    if (!typeInput || !formatSelect || !formatLabel) return;

    const type = typeInput.value;
    const options = type === "file"
      ? fileFormatOptions
      : type === "string"
        ? stringFormatOptions
        : [{ value: "", label: "指定なし" }];
    const allowLegacyOption = preferredValue !== null;
    const currentValue = preferredValue ?? formatSelect.value ?? "";

    formatSelect.innerHTML = "";
    options.forEach((item) => {
      const option = document.createElement("option");
      option.value = item.value;
      option.textContent = item.label;
      formatSelect.appendChild(option);
    });
    if (allowLegacyOption && currentValue && !options.some((item) => item.value === currentValue)) {
      const legacyOption = document.createElement("option");
      legacyOption.value = currentValue;
      legacyOption.textContent = `${currentValue}（既存設定）`;
      formatSelect.appendChild(legacyOption);
    }
    formatSelect.value = options.some((item) => item.value === currentValue) || allowLegacyOption
      ? currentValue
      : "";
    formatLabel.textContent = type === "file" ? "ファイル分類" : "フォーマット";
  }

  function normalizeAllowedExtensionsInput(raw) {
    const tokens = String(raw || "")
      .split(",")
      .map((item) => item.trim().toLowerCase())
      .filter((item) => item.length > 0)
      .map((item) => item.startsWith(".") ? item : `.${item}`);
    const seen = new Set();
    const normalized = [];
    tokens.forEach((item) => {
      if (seen.has(item)) return;
      seen.add(item);
      normalized.push(item);
    });
    return normalized;
  }

  function formatAllowedExtensionsInput(values) {
    if (!Array.isArray(values)) return "";
    return values
      .map((item) => String(item || "").trim())
      .filter((item) => item.length > 0)
      .join(", ");
  }

  function syncFileExtensionPriority(row) {
    const typeInput = row.querySelector('[data-field="type"]');
    const formatSelect = row.querySelector('[data-field="format"]');
    const extInput = row.querySelector('[data-field="allowed_extensions_input"]');
    if (!typeInput || !formatSelect || !extInput) return;
    const isFile = typeInput.value === "file";
    const hasManualExtensions = normalizeAllowedExtensionsInput(extInput.value).length > 0;
    const disabled = isFile && hasManualExtensions;
    formatSelect.disabled = disabled;
    formatSelect.classList.toggle("bg-slate-100", disabled);
    formatSelect.title = disabled ? "許可拡張子が設定されているため、ファイル分類は適用されません" : "";
  }

  function refreshMasterLabelOptions(row, preferredValue = "") {
    const formSelect = row.querySelector('[data-field="master_form_id"]');
    const labelSelect = row.querySelector('[data-field="master_label_key"]');
    if (!formSelect || !labelSelect) return;

    const selectedFormId = formSelect.value || "";
    const options = masterFieldCatalog[selectedFormId] || [];
    const currentValue = preferredValue || labelSelect.value || "";

    labelSelect.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "自動（参照内容から生成）";
    labelSelect.appendChild(defaultOption);

    options.forEach((item) => {
      const option = document.createElement("option");
      option.value = item.key || "";
      option.textContent = item.label || item.key || "";
      labelSelect.appendChild(option);
    });

    if (currentValue && !options.some((item) => item.key === currentValue)) {
      const legacyOption = document.createElement("option");
      legacyOption.value = currentValue;
      legacyOption.textContent = `${currentValue}（既存設定）`;
      labelSelect.appendChild(legacyOption);
    }
    labelSelect.value = currentValue;
  }

  function refreshMasterDisplayFieldOptions(row, selectedKeys = []) {
    const formSelect = row.querySelector('[data-field="master_form_id"]');
    const displayContainer = row.querySelector('[data-role="master-display-fields"]');
    if (!formSelect || !displayContainer) return;

    const selectedFormId = formSelect.value || "";
    const options = masterFieldCatalog[selectedFormId] || [];
    const normalizedSelected = Array.isArray(selectedKeys)
      ? selectedKeys.map((item) => String(item || "").trim()).filter((item) => item.length > 0)
      : [];
    const selectedSet = new Set(normalizedSelected);

    displayContainer.replaceChildren();
    if (options.length === 0) {
      const empty = document.createElement("div");
      empty.className = "text-xs text-slate-400";
      empty.textContent = "表示できるフィールドがありません";
      displayContainer.appendChild(empty);
      return;
    }

    options.forEach((item) => {
      const key = item.key || "";
      if (!key) return;
      const wrapper = document.createElement("label");
      wrapper.className = "flex items-center gap-2";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "rounded border-slate-300";
      checkbox.dataset.field = "master_display_field";
      checkbox.value = key;
      checkbox.checked = selectedSet.has(key);
      checkbox.addEventListener("change", () => updateFieldsJson());
      const text = document.createElement("span");
      text.textContent = item.label || key;
      wrapper.appendChild(checkbox);
      wrapper.appendChild(text);
      displayContainer.appendChild(wrapper);
    });

    normalizedSelected.forEach((key) => {
      if (options.some((item) => item.key === key)) return;
      const wrapper = document.createElement("label");
      wrapper.className = "flex items-center gap-2 text-slate-500";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "rounded border-slate-300";
      checkbox.dataset.field = "master_display_field";
      checkbox.value = key;
      checkbox.checked = true;
      checkbox.addEventListener("change", () => updateFieldsJson());
      const text = document.createElement("span");
      text.textContent = `${key}（既存設定）`;
      wrapper.appendChild(checkbox);
      wrapper.appendChild(text);
      displayContainer.appendChild(wrapper);
    });
  }

  function initMasterConfig(row, selectedFormId, selectedLabelKey, selectedDisplayFields = []) {
    const formSelect = row.querySelector('[data-field="master_form_id"]');
    const labelSelect = row.querySelector('[data-field="master_label_key"]');
    if (!formSelect || !labelSelect) return;

    formSelect.innerHTML = "";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "選択してください";
    formSelect.appendChild(defaultOption);

    masterForms.forEach((item) => {
      const option = document.createElement("option");
      option.value = item.id || "";
      option.textContent = item.name || item.id || "";
      formSelect.appendChild(option);
    });
    formSelect.value = selectedFormId || "";
    refreshMasterLabelOptions(row, selectedLabelKey || "");
    refreshMasterDisplayFieldOptions(row, selectedDisplayFields || []);
  }

  function applyVisibility(row) {
    const type = row.querySelector('[data-field="type"]').value;
    const isArray = row.querySelector('[data-field="is_array"]').checked;
    const isGroup = type === "group";
    const showEnum = type === "enum";
    const showMasterConfig = type === "master";
    const showMinMax = type === "number" || type === "integer";
    const showFormat = type === "string" || type === "file";
    const showPlaceholder = type === "string";
    const showFileExtensions = type === "file";
    const showMultiline = type === "string";
    const showExpandRows = isGroup && isArray;
    row.querySelector('[data-role="enum"]').classList.toggle("hidden", !showEnum);
    row.querySelector('[data-role="master-config"]').classList.toggle("hidden", !showMasterConfig);
    row.querySelector('[data-role="minmax"]').classList.toggle("hidden", !showMinMax);
    row.querySelector('[data-role="format"]').classList.toggle("hidden", isGroup || !showFormat);
    row.querySelector('[data-role="placeholder"]').classList.toggle("hidden", isGroup || !showPlaceholder);
    row.querySelector('[data-role="file-extensions"]').classList.toggle("hidden", !showFileExtensions);
    row.querySelector('[data-role="multiline"]').classList.toggle("hidden", isGroup || !showMultiline);
    row.querySelector('[data-role="expand-rows"]').classList.toggle("hidden", !showExpandRows);
    row.querySelector('[data-role="group-children"]').classList.toggle("hidden", !isGroup);

    if (!showExpandRows) {
      row.querySelector('[data-field="expand_rows"]').checked = false;
    }

    if (!isGroup) {
      applyMultiline(row);
    }
    refreshFormatOptions(row);
    syncFileExtensionPriority(row);
    if (showMasterConfig) {
      refreshMasterLabelOptions(row);
      refreshMasterDisplayFieldOptions(
        row,
        Array.from(row.querySelectorAll('[data-field="master_display_field"]:checked')).map((el) => el.value)
      );
    } else {
      const formSelect = row.querySelector('[data-field="master_form_id"]');
      const labelSelect = row.querySelector('[data-field="master_label_key"]');
      const displayContainer = row.querySelector('[data-role="master-display-fields"]');
      if (formSelect) {
        formSelect.value = "";
      }
      if (labelSelect) {
        labelSelect.value = "";
      }
      if (displayContainer) {
        displayContainer.replaceChildren();
      }
    }
  }

  function readRow(row) {
    const get = (name) => row.querySelector(`[data-field="${name}"]`);
    const type = get("type").value;
    const isArray = get("is_array").checked;
    const enumRaw = get("enum").value || "";
    const enumValues = enumRaw
      .split(",")
      .map((value) => value.trim())
      .filter((value) => value.length > 0);

    const result = {
      key: get("key").value.trim(),
      label: get("label").value.trim(),
      type,
      required: get("required").checked,
      description: get("description").value.trim(),
      placeholder: get("placeholder").value.trim(),
      enum: enumValues,
      min: get("min").value.trim(),
      max: get("max").value.trim(),
      format: get("format").value,
      allowed_extensions: type === "file"
        ? normalizeAllowedExtensionsInput(get("allowed_extensions_input").value)
        : [],
      is_array: isArray,
      expand_rows: type === "group" && isArray ? get("expand_rows").checked : false,
      items_type: isArray ? type : "",
      multiline: get("multiline").checked,
      master_form_id: type === "master" ? get("master_form_id").value : "",
      master_label_key: type === "master" ? get("master_label_key").value : "",
      master_display_fields: type === "master"
        ? Array.from(row.querySelectorAll('[data-field="master_display_field"]:checked')).map((el) => el.value)
        : [],
      children: [],
    };

    if (type === "group") {
      const childrenList = row.querySelector(".children-list");
      if (childrenList) {
        const childRows = Array.from(childrenList.querySelectorAll(":scope > .field-row"));
        result.children = childRows.map((cr) => readRow(cr));
      }
    }

    return result;
  }

  function readFieldsFromContainer(container) {
    const rows = Array.from(container.querySelectorAll(":scope > .field-row"));
    return rows.map((row) => readRow(row));
  }

  function updateFieldsJson() {
    refreshRowDepthStyles();
    const fields = readFieldsFromContainer(fieldList);
    fieldsInput.value = JSON.stringify(fields);
  }

  function initSortable(container) {
    if (window.Sortable) {
      new Sortable(container, {
        animation: 150,
        handle: ".drag-handle",
        onSort: updateFieldsJson,
      });
    }
  }

  function attachRowEvents(row) {
    row.querySelectorAll(":scope > .mt-3 input, :scope > .mt-3 select, :scope > .mt-3 textarea, :scope > div > div > .flex input").forEach((input) => {
      input.addEventListener("change", () => {
        applyVisibility(row);
        updateFieldsJson();
      });
      input.addEventListener("input", () => {
        if (input.dataset.field === "allowed_extensions_input") {
          syncFileExtensionPriority(row);
        }
        updateFieldsJson();
      });
    });
    const masterFormSelect = row.querySelector('[data-field="master_form_id"]');
    if (masterFormSelect) {
      masterFormSelect.addEventListener("change", () => {
        refreshMasterLabelOptions(row, "");
        refreshMasterDisplayFieldOptions(row, []);
      });
    }
    row.querySelector('[data-action="remove"]').addEventListener("click", () => {
      row.remove();
      updateFieldsJson();
    });
    const addChildBtn = row.querySelector('[data-action="add-child"]');
    if (addChildBtn) {
      addChildBtn.addEventListener("click", () => {
        pendingAddTarget = row.querySelector(".children-list");
        typeModal.classList.remove("hidden");
        typeModal.classList.add("flex");
      });
    }
    applyVisibility(row);
  }

  function addRow(field, container) {
    const targetContainer = container || fieldList;
    const row = template.content.firstElementChild.cloneNode(true);
    const normalized = ensureKey(normalizeField(field));
    setValue(row, "key", normalized.key);
    setValue(row, "label", normalized.label);
    setValue(row, "type", normalized.type);
    setValue(row, "required", normalized.required);
    setValue(row, "description", normalized.description);
    setValue(row, "placeholder", normalized.placeholder);
    setValue(row, "enum", (normalized.enum || []).join(", "));
    setValue(row, "min", normalized.min ?? "");
    setValue(row, "max", normalized.max ?? "");
    refreshFormatOptions(row, normalized.format ?? "");
    setValue(row, "allowed_extensions_input", formatAllowedExtensionsInput(normalized.allowed_extensions || []));
    setValue(row, "is_array", normalized.is_array);
    setValue(row, "expand_rows", normalized.expand_rows);
    setValue(row, "multiline", normalized.multiline);
    initMasterConfig(
      row,
      normalized.master_form_id,
      normalized.master_label_key,
      normalized.master_display_fields || []
    );

    attachRowEvents(row);
    targetContainer.appendChild(row);

    if (normalized.type === "group" && normalized.children && normalized.children.length > 0) {
      const childrenList = row.querySelector(".children-list");
      for (const child of normalized.children) {
        addRow(child, childrenList);
      }
      initSortable(childrenList);
    }
  }

  addButton.addEventListener("click", () => {
    pendingAddTarget = null;
    if (typeModal) {
      typeModal.classList.remove("hidden");
      typeModal.classList.add("flex");
    }
  });

  if (closeTypeModal) {
    closeTypeModal.addEventListener("click", () => {
      pendingAddTarget = null;
      typeModal.classList.add("hidden");
      typeModal.classList.remove("flex");
    });
  }

  document.querySelectorAll(".type-option").forEach((button) => {
    button.addEventListener("click", () => {
      const selectedType = button.dataset.type || "string";
      const target = pendingAddTarget || fieldList;
      addRow({ ...defaultField, type: selectedType }, target);
      if (pendingAddTarget && window.Sortable && !pendingAddTarget._sortableInitialized) {
        initSortable(pendingAddTarget);
        pendingAddTarget._sortableInitialized = true;
      }
      pendingAddTarget = null;
      updateFieldsJson();
      typeModal.classList.add("hidden");
      typeModal.classList.remove("flex");
    });
  });

  if (initialFields.length > 0) {
    initialFields.forEach((field) => addRow(field));
  }

  updateFieldsJson();

  initSortable(fieldList);

  document.querySelector("form").addEventListener("submit", () => {
    updateFieldsJson();
  });
</script>
{% endblock %}
